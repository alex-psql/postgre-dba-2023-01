### Работа с журналами
Выполнял на своей виртуальной машине Ubuntu 22.04, т.к. в приоритете на данный момент on-premise решение. Установлен кластер PG14.
___
1. Настроить выполнение контрольных точек раз в 30 секунд в postgresql.conf

>checkpoint_timeout = 30s  
max_wal_size = 16GB  
min_wal_size = 1.6GB


2. Создать дб для теста и подать нагрузку.
>CREATE DATABASE bench;  
pgbench -i bench  
pgbench -c 8 -P 60 -T 600 bench

3. Измерьте, какой объем журнальных файлов был сгенерирован за это время.
>ls -l --block-size=M /mnt/data/14/main/pg_wal/  
>total 64m

4. Оценить, какой объем приходится в среднем на одну контрольную точку.
>MB per checkpoint   | 1.58  

Использовал найденный на просторах интернета запрос с отчетом по чекпоинтам. Так же можно вытащить из лога (ниже).

5. Проверить, все ли контрольные точки выполнялись по расписанию.
>включить в конфиге логирование чекпоинтов, произвести повторный замер  

>grep "checkpoint starting" /var/log/postgresql/postgresql-14-main.log  
2023-03-09 12:16:32.538 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:17:02.118 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:17:32.174 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:18:02.122 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:18:32.161 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:19:02.122 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:19:32.094 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:20:02.237 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:20:32.178 UTC [125688] LOG:  checkpoint starting: time  
2023-03-09 12:21:02.138 UTC [125688] LOG:  checkpoint starting: time  

Всё вовремя, потому что время записи чекпоинта write=26.792 секунд. 

6. Замерить tps при асинхронном режиме.
>progress: 240.0 s, 5122.5 tps, lat 1.561 ms stddev 1.253

Ускорение в 10 раз. Нет контроля записи. Опасно для критичных данных. 

7. Контрольные суммы.
При старте проходит проверка. Если проверка не выполняется, получаем ошибку. 
>ERROR: invalid page
Чтобы обойти, необходио в конфиге включить ignore_checksum_failure. Инструмент, когда нет бэкапа/зеркала, чтобы достать все сохранившиеся данные. Включать контроль суммы следует только на критически точных данных в дополнение к внутренним ограничителям бд. 
